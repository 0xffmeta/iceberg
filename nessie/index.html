<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://iceberg.apache.org/nessie/">
    <link rel="shortcut icon" href="../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Nessie - Apache Iceberg</title>
    <link href="../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/highlight.css">
    <link href="../css/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/bootstrap-3.3.7.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Iceberg Nessie Integration", url: "#_top", children: [
              {title: "Enabling Nessie Catalog", url: "#enabling-nessie-catalog" },
              {title: "Spark SQL Extensions", url: "#spark-sql-extensions" },
              {title: "Nessie Catalog", url: "#nessie-catalog" },
              {title: "Nessie and Iceberg", url: "#nessie-and-iceberg" },
              {title: "Example", url: "#example" },
              {title: "Future Improvements", url: "#future-improvements" },
          ]},
        ];

    </script>
    <script src="../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <!--
 - Licensed to the Apache Software Foundation (ASF) under one or more
 - contributor license agreements.  See the NOTICE file distributed with
 - this work for additional information regarding copyright ownership.
 - The ASF licenses this file to You under the Apache License, Version 2.0
 - (the "License"); you may not use this file except in compliance with
 - the License.  You may obtain a copy of the License at
 -
 -   http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS,
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 - See the License for the specific language governing permissions and
 - limitations under the License.
 -->

<h1 id="iceberg-nessie-integration">Iceberg Nessie Integration<a class="headerlink" href="#iceberg-nessie-integration" title="Permanent link">&para;</a></h1>
<p>Iceberg provides integration with Nessie through the <code>iceberg-nessie</code> module.
This section describes how to use Iceberg with Nessie. Nessie provides several key features on top of Iceberg:</p>
<ul>
<li>multi-table transactions</li>
<li>git-like operations (eg branches, tags, commits)</li>
<li>hive-like metastore capabilities</li>
</ul>
<p>See <a href="https://projectnessie.org">Project Nessie</a> for more information on Nessie. Nessie requires a server to run, see
<a href="https://projectnessie.org/try/">Getting Started</a> to start a Nessie server.</p>
<h2 id="enabling-nessie-catalog">Enabling Nessie Catalog<a class="headerlink" href="#enabling-nessie-catalog" title="Permanent link">&para;</a></h2>
<p>The <code>iceberg-nessie</code> module is bundled with Spark and Flink runtimes for all versions from <code>0.11.0</code>. To get started
with Nessie and Iceberg simply add the Iceberg runtime to your process. Eg: <code>spark-sql --packages
org.apache.iceberg:iceberg-spark3-runtiume:0.12.1</code>. </p>
<h2 id="spark-sql-extensions">Spark SQL Extensions<a class="headerlink" href="#spark-sql-extensions" title="Permanent link">&para;</a></h2>
<p>From spark, Nessie SQL extensions can be used to manage the Nessie repo as shown below. </p>
<pre><code>bin/spark-sql 
  --packages &quot;org.apache.iceberg:iceberg-spark3-runtime:0.12.1,org.projectnessie:nessie-spark-extensions:0.9.2&quot;
  --conf spark.sql.extensions=&quot;org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions,org.projectnessie.spark.extensions.NessieSparkSessionExtensions&quot;
  --conf &lt;other settings&gt;
</code></pre>
<p>Please refer <a href="https://projectnessie.org/tools/sql/">Nessie SQL extension document</a> to learn more about it.</p>
<h2 id="nessie-catalog">Nessie Catalog<a class="headerlink" href="#nessie-catalog" title="Permanent link">&para;</a></h2>
<p>One major feature introduced in release <code>0.11.0</code> is the ability to easily interact with a <a href="../custom-catalog">Custom
Catalog</a> from Spark and Flink. See <a href="../spark-configuration#catalog-configuration">Spark Configuration</a>
  and <a href="../flink#custom-catalog">Flink Configuration</a> for instructions for adding a custom catalog to Iceberg. </p>
<p>To use the Nessie Catalog the following properties are required:</p>
<ul>
<li><code>warehouse</code>. Like most other catalogs the warehouse property is a file path to where this catalog should store tables.</li>
<li><code>uri</code>. This is the Nessie server base uri. Eg <code>http://localhost:19120/api/v1</code>.</li>
<li><code>ref</code> (optional). This is the Nessie branch or tag you want to work in.</li>
</ul>
<p>To run directly in Java this looks like:</p>
<pre><code class="language-java">Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
options.put(&quot;warehouse&quot;, &quot;/path/to/warehouse&quot;);
options.put(&quot;ref&quot;, &quot;main&quot;);
options.put(&quot;uri&quot;, &quot;https://localhost:19120/api/v1&quot;);
Catalog nessieCatalog = CatalogUtil.loadCatalog(&quot;org.apache.iceberg.nessie.NessieCatalog&quot;, &quot;nessie&quot;, hadoopConfig, options);
</code></pre>
<p>and in Spark:</p>
<pre><code class="language-java">conf.set(&quot;spark.sql.catalog.nessie.warehouse&quot;, &quot;/path/to/warehouse&quot;);
conf.set(&quot;spark.sql.catalog.nessie.uri&quot;, &quot;http://localhost:19120/api/v1&quot;)
conf.set(&quot;spark.sql.catalog.nessie.ref&quot;, &quot;main&quot;)
conf.set(&quot;spark.sql.catalog.nessie.catalog-impl&quot;, &quot;org.apache.iceberg.nessie.NessieCatalog&quot;)
conf.set(&quot;spark.sql.catalog.nessie&quot;, &quot;org.apache.iceberg.spark.SparkCatalog&quot;)
conf.set(&quot;spark.sql.extensions&quot;, &quot;org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions,org.projectnessie.spark.extensions.NessieSparkSessionExtensions&quot;)
</code></pre>
<p>This is how it looks in Flink via the Python API (additional details can be found <a href="../flink/">here</a>):</p>
<pre><code class="language-python">import os
from pyflink.datastream import StreamExecutionEnvironment
from pyflink.table import StreamTableEnvironment

env = StreamExecutionEnvironment.get_execution_environment()
iceberg_flink_runtime_jar = os.path.join(os.getcwd(), &quot;iceberg-flink-runtime-0.12.1.jar&quot;)
env.add_jars(&quot;file://{}&quot;.format(iceberg_flink_runtime_jar))
table_env = StreamTableEnvironment.create(env)

table_env.execute_sql(&quot;CREATE CATALOG nessie_catalog WITH (&quot;
                      &quot;'type'='iceberg', &quot;
                      &quot;'catalog-impl'='org.apache.iceberg.nessie.NessieCatalog', &quot;
                      &quot;'uri'='http://localhost:19120/api/v1', &quot;
                      &quot;'ref'='main', &quot;
                      &quot;'warehouse'='/path/to/warehouse')&quot;)
</code></pre>
<p>There is nothing special above about the <code>nessie</code> name. A spark catalog can have any name, the important parts are the 
settings for the <code>catalog-impl</code> and the required config to start Nessie correctly.
Once you have a Nessie catalog you have access to your entire Nessie repo. You can then perform create/delete/merge
operations on branches and perform commits on branches. Each Iceberg table in a Nessie Catalog is identified by an
arbitrary length namespace and table name (eg <code>data.base.name.table</code>). These namespaces are implicit and don&rsquo;t need to
be created separately. Any transaction on a Nessie enabled Iceberg table is a single commit in Nessie. Nessie commits
can encompass an arbitrary number of actions on an arbitrary number of tables, however in Iceberg this will be limited
to the set of single table transactions currently available.</p>
<p>Further operations such as merges, viewing the commit log or diffs are performed by direct interaction with the
<code>NessieClient</code> in java or by using the python client or cli. See <a href="https://projectnessie.org/tools/cli/">Nessie CLI</a> for
more details on the CLI and <a href="https://projectnessie.org/tools/iceberg/spark/">Spark Guide</a> for a more complete description of 
Nessie functionality.</p>
<h2 id="nessie-and-iceberg">Nessie and Iceberg<a class="headerlink" href="#nessie-and-iceberg" title="Permanent link">&para;</a></h2>
<p>For most cases Nessie acts just like any other Catalog for Iceberg: providing a logical organization of a set of tables
and providing atomicity to transactions. However, using Nessie opens up other interesting possibilities. When using Nessie with
Iceberg every Iceberg transaction becomes a Nessie commit. This history can be listed, merged or cherry-picked across branches.</p>
<h3 id="loosely-coupled-transactions">Loosely coupled transactions<a class="headerlink" href="#loosely-coupled-transactions" title="Permanent link">&para;</a></h3>
<p>By creating a branch and performing a set of operations on that branch you can approximate a multi-table transaction.
A sequence of commits can be performed on the newly created branch and then merged back into the main branch atomically.
This gives the appearance of a series of connected changes being exposed to the main branch simultaneously. While downstream
consumers will see multiple transactions appear at once this isn&rsquo;t a true multi-table transaction on the database. It is 
effectively a fast-forward merge of multiple commits (in git language) and each operation from the branch is its own distinct
transaction and commit. This is different from a real multi-table transaction where all changes would be in the same commit.
This does allow multiple applications to take part in modifying a branch and for this distributed set of transactions to be 
exposed to the downstream users simultaneously.</p>
<h3 id="experimentation">Experimentation<a class="headerlink" href="#experimentation" title="Permanent link">&para;</a></h3>
<p>Changes to a table can be tested in a branch before merging back into main. This is particularly useful when performing
large changes like schema evolution or partition evolution. A partition evolution could be performed in a branch and you
would be able to test out the change (eg performance benchmarks) before merging it. This provides great flexibility in
performing on-line table modifications and testing without interrupting downstream use cases. If the changes are
incorrect or not performant the branch can be dropped without being merged.</p>
<h3 id="further-use-cases">Further use cases<a class="headerlink" href="#further-use-cases" title="Permanent link">&para;</a></h3>
<p>Please see the <a href="https://projectnessie.org/features/">Nessie Documentation</a> for further descriptions of 
Nessie features.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Regular table maintenance in Iceberg is complicated when using nessie. Please consult
<a href="https://projectnessie.org/features/management/">Management Services</a> before performing any 
<a href="../maintenance">table maintenance</a>.</p>
</div>
<h2 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h2>
<p>Please have a look at the <a href="https://github.com/projectnessie/nessie-demos">Nessie Demos repo</a>
for different examples of Nessie and Iceberg in action together.</p>
<h2 id="future-improvements">Future Improvements<a class="headerlink" href="#future-improvements" title="Permanent link">&para;</a></h2>
<ul>
<li>Iceberg multi-table transactions. Changes to multiple Iceberg tables in the same transaction, isolation levels etc</li>
</ul>

  <br>
</div>

<footer class="container-fluid wm-page-content"><p>Copyright 2018-2021 <a href='https://www.apache.org/'>The Apache Software Foundation</a><br />Apache Iceberg, Iceberg, Apache, the Apache feather logo, and the Apache Iceberg project logo are either registered<br />trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>